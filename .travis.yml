language: generic

sudo: true # Otherwise there seems to be no fuse available
dist: trusty

env:
  global:
    - DISPLAY=:99

script:
  - sudo apt-get -qq -y install libxml-xpath-perl xvfb icewm x11-utils x11-apps netpbm xdotool libgl1-mesa-dri > /dev/null # appstream # TODO: Cache me!
  - # xpra start :99 # Cannot get screenshots to work
  - Xvfb :99 >/dev/null 2>&1 &
  - # until xset -q; do echo "Waiting for X server to start..."; sleep 1; done # We are not immediately using it anyway
  - # Find out which files in data/ have been changed in the last commit
  - FILES=$(git log -1 -p data/ | grep +++ | cut -d '/' -f 2- | sed -e 's|dev/null||g')
  - # Work on these files that have been changed in the last commit
  - for FILE in $FILES ; do echo "$FILE" ; bash -e code/worker.sh $(readlink -f "$FILE") ; done

after_script:
  - # xpra stop :99
  - killall Xvfb
